<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信登录回调 - 智能记账</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
        .callback-container { background:white; border-radius:20px; padding:40px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,0.1); max-width:400px; width:100%; }
        .loading-spinner { width:60px; height:60px; border:4px solid #f3f3f3; border-top:4px solid #09bb07; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px; }
        @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .success-icon{width:60px;height:60px;background:#09bb07;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;color:white;font-size:24px}
        .error-icon{width:60px;height:60px;background:#ff4757;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;color:white;font-size:24px}
        h1{color:#333;margin-bottom:10px;font-size:1.5rem}
        p{color:#666;margin-bottom:30px;line-height:1.5}
        .btn{background:#09bb07;color:white;border:none;padding:12px 30px;border-radius:25px;font-size:16px;cursor:pointer;text-decoration:none}
        .btn-secondary{background:#6c757d;margin-left:10px}
        .hidden{display:none}
    </style>
</head>
<body>
    <div class="callback-container">
        <div id="loading-section">
            <div class="loading-spinner"></div>
            <h1>正在验证登录信息</h1>
            <p>请稍候，我们正在处理您的微信登录信息...</p>
        </div>
        <div id="success-section" class="hidden">
            <div class="success-icon"><i class="fas fa-check"></i></div>
            <h1>登录成功！</h1>
            <p>微信登录验证成功，正在为您跳转...</p>
            <button class="btn" onclick="redirectToApp()">立即跳转</button>
        </div>
        <div id="error-section" class="hidden">
            <div class="error-icon"><i class="fas fa-exclamation"></i></div>
            <h1>登录失败</h1>
            <p id="error-message">微信登录验证失败，请重试</p>
            <button class="btn" onclick="retryLogin()">重新登录</button>
            <button class="btn btn-secondary" onclick="goBack()">返回</button>
        </div>
    </div>

    <!-- 加载支付登录管理器 -->
    <script src="src/js/payment-login-manager.js"></script>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');

        document.addEventListener('DOMContentLoaded', async function() {
            // 使用支付登录管理器处理回调
            if (typeof window.PaymentLoginManager !== 'undefined') {
                const manager = new window.PaymentLoginManager({
                    showToast: function(message) {
                        console.log('微信回调:', message);
                    }
                });
                
                // 处理微信回调
                await manager.handleWechatCallback(code, state);
            } else {
                // 备用处理方案
                handleWechatCallbackFallback(code, state);
            }
            if (!code || !state) { showError('缺少必要的授权参数'); return; }

            try {
                const savedState = sessionStorage.getItem('wechat_oauth_state');
                if (state !== savedState) { showError('状态参数验证失败'); return; }

                // Demo 模式：直接写入 localStorage
                const authUser = { provider:'wechat', nickname:'微信用户', avatar:'', tokenInfo:{ access_token:'demo_access_token_'+Date.now() } };
                localStorage.setItem('auth_user', JSON.stringify(authUser));

                const paymentConnections = JSON.parse(localStorage.getItem('paymentConnections')||'{}');
                paymentConnections.wechat = { connected:true, connectedAt:new Date().toISOString(), lastSync:new Date().toISOString(), userInfo:{ nickname: authUser.nickname } };
                localStorage.setItem('paymentConnections', JSON.stringify(paymentConnections));

                showSuccess();
                setTimeout(()=>redirectToApp(), 1500);
            } catch (err) { console.error(err); showError(err.message||'处理失败'); }
        });

        function showLoading(){document.getElementById('loading-section').classList.remove('hidden');document.getElementById('success-section').classList.add('hidden');document.getElementById('error-section').classList.add('hidden')}
        function showSuccess(){document.getElementById('loading-section').classList.add('hidden');document.getElementById('success-section').classList.remove('hidden');document.getElementById('error-section').classList.add('hidden')}
        function showError(msg){document.getElementById('loading-section').classList.add('hidden');document.getElementById('success-section').classList.add('hidden');document.getElementById('error-section').classList.remove('hidden');document.getElementById('error-message').textContent = msg}
        function redirectToApp(){ const redirectUrl = sessionStorage.getItem('wechat_oauth_redirect') || '/'; window.location.href = redirectUrl }
        function retryLogin(){ const redirectUri = window.location.origin + '/wechat-callback.html'; const state = 'wechat_oauth_'+Date.now()+'_'+Math.random().toString(36).slice(2); sessionStorage.setItem('wechat_oauth_state', state); sessionStorage.setItem('wechat_oauth_redirect', '/'); const authUrl = `https://open.weixin.qq.com/connect/qrconnect?appid=APPID&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=snsapi_login&state=${state}#wechat_redirect`; window.location.href = authUrl }
        function goBack(){ window.history.back() }
    </script>
</body>
</html>
