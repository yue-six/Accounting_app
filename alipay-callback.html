<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付宝登录回调 - 智能记账</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#4fd1c5 0%,#1677ff 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .container{background:#fff;padding:36px;border-radius:16px;max-width:420px;width:100%;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.1)}
        .spinner{width:56px;height:56px;border:4px solid #f3f3f3;border-top-color:#1677ff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 18px}
        @keyframes spin{to{transform:rotate(360deg)}}
        h1{font-size:1.4rem;color:#333;margin-bottom:8px}
        p{color:#666;margin-bottom:18px}
        .btn{background:#1677ff;color:#fff;padding:10px 20px;border-radius:20px;border:none;cursor:pointer}
        .hidden{display:none}
    </style>
</head>
<body>
    <div class="container">
        <div id="loading"><div class="spinner"></div><h1>正在处理支付宝登录</h1><p>请稍候...</p></div>
        <div id="success" class="hidden"><div style="font-size:48px;color:#1677ff;margin-bottom:12px">✓</div><h1>登录成功</h1><p>即将返回应用</p><button class="btn" onclick="redirectToApp()">返回</button></div>
        <div id="error" class="hidden"><div style="font-size:48px;color:#ff4d4f;margin-bottom:12px">✕</div><h1>登录失败</h1><p id="errMsg">请求失败</p><button class="btn" onclick="goBack()">返回</button></div>
    </div>

    <!-- 加载支付登录管理器 -->
    <script src="src/js/payment-login-manager.js"></script>
    
    <script>
        const params = new URLSearchParams(window.location.search);
        const code = params.get('auth_code') || params.get('code');
        const state = params.get('state');

        document.addEventListener('DOMContentLoaded', async ()=>{
            if(!code || !state){ showError('缺少授权参数'); return; }
            
            // 使用支付登录管理器处理回调
            if (typeof window.PaymentLoginManager !== 'undefined') {
                const manager = new window.PaymentLoginManager({
                    showToast: function(message) {
                        console.log('支付宝回调:', message);
                    }
                });
                
                // 处理支付宝回调
                await manager.handleAlipayCallback(code, state);
            } else {
                // 备用处理方案
                handleAlipayCallbackFallback(code, state);
            }

        function showSuccess(){ document.getElementById('loading').classList.add('hidden'); document.getElementById('success').classList.remove('hidden'); }
        function showError(msg){ document.getElementById('loading').classList.add('hidden'); document.getElementById('error').classList.remove('hidden'); document.getElementById('errMsg').textContent = msg }
        function redirectToApp(){ const r = sessionStorage.getItem('alipay_oauth_redirect') || '/'; window.location.href = r }
        function goBack(){ window.history.back() }
    </script>
</body>
</html>
