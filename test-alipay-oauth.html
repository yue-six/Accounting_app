<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜å®OAuth2å‰ç«¯åŠŸèƒ½æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1677FF 0%, #1890FF 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
        }
        
        .test-section h2 {
            color: #1677FF;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .test-button {
            background: #1677FF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
            transition: background 0.3s;
            width: 100%;
        }
        
        .test-button:hover {
            background: #0958d9;
        }
        
        .test-button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        
        .error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        
        .info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        
        .code {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status.ready {
            background: #52c41a;
            color: white;
        }
        
        .status.error {
            background: #ff4d4f;
            color: white;
        }
        
        .status.warning {
            background: #faad14;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ”¯ä»˜å®OAuth2å‰ç«¯åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. æ”¯ä»˜å®OAuthæœåŠ¡ç±»æµ‹è¯•</h2>
            <button class="test-button" onclick="testAlipayOAuthService()">æµ‹è¯•æ”¯ä»˜å®OAuthæœåŠ¡ç±»</button>
            <div id="service-test-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>2. æˆæƒé“¾æ¥ç”Ÿæˆæµ‹è¯•</h2>
            <button class="test-button" onclick="testAuthUrlGeneration()">ç”Ÿæˆæˆæƒé“¾æ¥</button>
            <div id="auth-url-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>3. çŠ¶æ€å‚æ•°ç®¡ç†æµ‹è¯•</h2>
            <button class="test-button" onclick="testStateManagement()">æµ‹è¯•çŠ¶æ€å‚æ•°ç®¡ç†</button>
            <div id="state-test-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>4. å›è°ƒå‚æ•°æ£€æŸ¥æµ‹è¯•</h2>
            <button class="test-button" onclick="testCallbackCheck()">æ£€æŸ¥å½“å‰é¡µé¢å›è°ƒå‚æ•°</button>
            <div id="callback-test-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>5. å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•</h2>
            <button class="test-button" onclick="testFullLoginFlow()">å¯åŠ¨å®Œæ•´ç™»å½•æµç¨‹</button>
            <div class="code">
// å®Œæ•´ç™»å½•æµç¨‹ï¼š
// 1. ç”ŸæˆæˆæƒURL
// 2. ä¿å­˜çŠ¶æ€å‚æ•°
// 3. è·³è½¬åˆ°æ”¯ä»˜å®æˆæƒé¡µé¢
// 4. ç”¨æˆ·æˆæƒåè¿”å›å›è°ƒé¡µé¢
// 5. å¤„ç†å›è°ƒå¹¶è·å–ç”¨æˆ·ä¿¡æ¯
            </div>
            <div id="login-test-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>6. å½“å‰çŠ¶æ€ä¿¡æ¯</h2>
            <button class="test-button" onclick="showCurrentStatus()">æ˜¾ç¤ºå½“å‰çŠ¶æ€</button>
            <div id="status-result" class="result"></div>
        </div>
    </div>

    <script src="/src/js/alipay-oauth.js"></script>
    <script>
        // æµ‹è¯•æ”¯ä»˜å®OAuthæœåŠ¡ç±»
        function testAlipayOAuthService() {
            const resultEl = document.getElementById('service-test-result');
            resultEl.innerHTML = '';
            resultEl.className = 'result info';
            
            try {
                if (!window.alipayOAuth) {
                    throw new Error('æ”¯ä»˜å®OAuthæœåŠ¡ç±»æœªåŠ è½½');
                }
                
                const service = window.alipayOAuth;
                const testResults = [];
                
                // æµ‹è¯•é…ç½®
                testResults.push('âœ… æœåŠ¡ç±»åŠ è½½æˆåŠŸ');
                testResults.push(`ğŸ“± AppID: ${service.config.aconst redirectUri = 'https://warm-halva-bafc60.netlify.app/alipay-callback.html';
`);
                testResults.push(`ğŸ”— æˆæƒURL: ${service.config.authorizeUrl}`);
                testResults.push(`ğŸ¯ æˆæƒèŒƒå›´: ${service.config.scope}`);
                
                // æµ‹è¯•æ–¹æ³•å­˜åœ¨æ€§
                const methods = ['generateAuthUrl', 'generateState', 'saveOAuthState', 'validateState', 'startOAuthLogin'];
                methods.forEach(method => {
                    if (typeof service[method] === 'function') {
                        testResults.push(`âœ… æ–¹æ³• ${method} å­˜åœ¨`);
                    } else {
                        testResults.push(`âŒ æ–¹æ³• ${method} ä¸å­˜åœ¨`);
                    }
                });
                
                resultEl.innerHTML = testResults.join('\n');
                resultEl.className = 'result success';
                
            } catch (error) {
                resultEl.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // æµ‹è¯•æˆæƒé“¾æ¥ç”Ÿæˆ
        function testAuthUrlGeneration() {
            const resultEl = document.getElementById('auth-url-result');
            resultEl.innerHTML = '';
            resultEl.className = 'result info';
            
            try {
                if (!window.alipayOAuth) {
                    throw new Error('æ”¯ä»˜å®OAuthæœåŠ¡ç±»æœªåŠ è½½');
                }
                
                const service = window.alipayOAuth;
                const redirectUri = window.location.origin + '/alipay-callback.html';
                const state = service.generateState();
                
                // ç”ŸæˆæˆæƒURL
                const authUrl = service.generateAuthUrl(redirectUri, state);
                
                const testResults = [];
                testResults.push('âœ… æˆæƒé“¾æ¥ç”ŸæˆæˆåŠŸ');
                testResults.push(`ğŸ”— å›è°ƒåœ°å€: ${redirectUri}`);
                testResults.push(`ğŸ”‘ Stateå‚æ•°: ${state}`);
                testResults.push(`ğŸŒ å®Œæ•´æˆæƒURL:`);
                testResults.push(authUrl);
                
                // éªŒè¯URLæ ¼å¼
                const url = new URL(authUrl);
                const params = new URLSearchParams(url.search);
                
                testResults.push('\nğŸ“‹ URLå‚æ•°éªŒè¯:');
                testResults.push(`âœ… app_id: ${params.get('app_id')}`);
                testResults.push(`âœ… scope: ${params.get('scope')}`);
                testResults.push(`âœ… redirect_uri: ${decodeURIComponent(params.get('redirect_uri'))}`);
                testResults.push(`âœ… state: ${params.get('state')}`);
                
                resultEl.innerHTML = testResults.join('\n');
                resultEl.className = 'result success';
                
            } catch (error) {
                resultEl.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // æµ‹è¯•çŠ¶æ€å‚æ•°ç®¡ç†
        function testStateManagement() {
            const resultEl = document.getElementById('state-test-result');
            resultEl.innerHTML = '';
            resultEl.className = 'result info';
            
            try {
                if (!window.alipayOAuth) {
                    throw new Error('æ”¯ä»˜å®OAuthæœåŠ¡ç±»æœªåŠ è½½');
                }
                
                const service = window.alipayOAuth;
                const testResults = [];
                
                // ç”Ÿæˆæµ‹è¯•çŠ¶æ€
                const testState = service.generateState();
                const testRedirect = window.location.href;
                
                // ä¿å­˜çŠ¶æ€
                service.saveOAuthState(testState, testRedirect);
                testResults.push('âœ… çŠ¶æ€å‚æ•°ä¿å­˜æˆåŠŸ');
                testResults.push(`ğŸ”‘ æµ‹è¯•State: ${testState}`);
                testResults.push(`ğŸ”— æµ‹è¯•é‡å®šå‘: ${testRedirect}`);
                
                // éªŒè¯çŠ¶æ€
                const isValid = service.validateState(testState);
                testResults.push(isValid ? 'âœ… çŠ¶æ€å‚æ•°éªŒè¯æˆåŠŸ' : 'âŒ çŠ¶æ€å‚æ•°éªŒè¯å¤±è´¥');
                
                // è·å–é‡å®šå‘URL
                const redirectUrl = service.getSavedRedirectUrl();
                testResults.push(`ğŸ”— ä¿å­˜çš„é‡å®šå‘URL: ${redirectUrl}`);
                
                // æ¸…é™¤çŠ¶æ€
                service.clearOAuthState();
                testResults.push('âœ… çŠ¶æ€å‚æ•°æ¸…é™¤æˆåŠŸ');
                
                // éªŒè¯æ¸…é™¤åçŠ¶æ€
                const isValidAfterClear = service.validateState(testState);
                testResults.push(isValidAfterClear ? 'âŒ çŠ¶æ€æ¸…é™¤å¤±è´¥' : 'âœ… çŠ¶æ€æ¸…é™¤éªŒè¯æˆåŠŸ');
                
                resultEl.innerHTML = testResults.join('\n');
                resultEl.className = 'result success';
                
            } catch (error) {
                resultEl.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // æµ‹è¯•å›è°ƒå‚æ•°æ£€æŸ¥
        function testCallbackCheck() {
            const resultEl = document.getElementById('callback-test-result');
            resultEl.innerHTML = '';
            resultEl.className = 'result info';
            
            try {
                if (!window.alipayOAuth) {
                    throw new Error('æ”¯ä»˜å®OAuthæœåŠ¡ç±»æœªåŠ è½½');
                }
                
                const service = window.alipayOAuth;
                const callbackParams = service.checkForOAuthCallback();
                
                if (callbackParams) {
                    const testResults = [];
                    testResults.push('ğŸ¯ æ£€æµ‹åˆ°å›è°ƒå‚æ•°:');
                    testResults.push(`ğŸ”‘ æˆæƒç : ${callbackParams.authCode}`);
                    testResults.push(`ğŸ”’ Stateå‚æ•°: ${callbackParams.state}`);
                    if (callbackParams.error) {
                        testResults.push(`âŒ é”™è¯¯: ${callbackParams.error}`);
                        testResults.push(`ğŸ“ é”™è¯¯æè¿°: ${callbackParams.errorDescription}`);
                    }
                    
                    resultEl.innerHTML = testResults.join('\n');
                    resultEl.className = callbackParams.error ? 'result error' : 'result success';
                } else {
                    resultEl.innerHTML = 'â„¹ï¸ å½“å‰é¡µé¢æœªæ£€æµ‹åˆ°æ”¯ä»˜å®å›è°ƒå‚æ•°';
                    resultEl.className = 'result info';
                }
                
            } catch (error) {
                resultEl.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // æµ‹è¯•å®Œæ•´ç™»å½•æµç¨‹
        function testFullLoginFlow() {
            const resultEl = document.getElementById('login-test-result');
            resultEl.innerHTML = '';
            resultEl.className = 'result info';
            
            try {
                if (!window.alipayOAuth) {
                    throw new Error('æ”¯ä»˜å®OAuthæœåŠ¡ç±»æœªåŠ è½½');
                }
                
                const service = window.alipayOAuth;
                const redirectUri = window.location.origin + '/alipay-callback.html';
                
                const testResults = [];
                testResults.push('ğŸš€ å¼€å§‹å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•...');
                
                // 1. ç”ŸæˆæˆæƒURL
                const authUrl = service.generateAuthUrl(redirectUri);
                testResults.push('âœ… æˆæƒURLç”ŸæˆæˆåŠŸ');
                
                // 2. ä¿å­˜çŠ¶æ€å‚æ•°
                const state = service.generateState();
                service.saveOAuthState(state, window.location.href);
                testResults.push('âœ… çŠ¶æ€å‚æ•°ä¿å­˜æˆåŠŸ');
                
                // 3. éªŒè¯çŠ¶æ€å‚æ•°
                const isValid = service.validateState(state);
                testResults.push(isValid ? 'âœ… çŠ¶æ€å‚æ•°éªŒè¯æˆåŠŸ' : 'âŒ çŠ¶æ€å‚æ•°éªŒè¯å¤±è´¥');
                
                // 4. æ˜¾ç¤ºæˆæƒURLï¼ˆä¸å®é™…è·³è½¬ï¼‰
                testResults.push('\nğŸŒ ç”Ÿæˆçš„æˆæƒURL:');
                testResults.push(authUrl);
                
                testResults.push('\nğŸ“‹ æµ‹è¯•æ€»ç»“:');
                testResults.push('âœ… æˆæƒé“¾æ¥æ‹¼æ¥åŠŸèƒ½æ­£å¸¸');
                testResults.push('âœ… çŠ¶æ€å‚æ•°ç®¡ç†åŠŸèƒ½æ­£å¸¸');
                testResults.push('âœ… å›è°ƒå¤„ç†å‡†å¤‡å°±ç»ª');
                testResults.push('\nğŸ’¡ æç¤º: å®é™…ä½¿ç”¨æ—¶è°ƒç”¨ startOAuthLogin() æ–¹æ³•ä¼šè‡ªåŠ¨è·³è½¬');
                
                resultEl.innerHTML = testResults.join('\n');
                resultEl.className = 'result success';
                
            } catch (error) {
                resultEl.innerHTML = `âŒ å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // æ˜¾ç¤ºå½“å‰çŠ¶æ€ä¿¡æ¯
        function showCurrentStatus() {
            const resultEl = document.getElementById('status-result');
            resultEl.innerHTML = '';
            resultEl.className = 'result info';
            
            try {
                const statusInfo = [];
                
                // æ£€æŸ¥æœåŠ¡ç±»çŠ¶æ€
                statusInfo.push('ğŸ”§ æ”¯ä»˜å®OAuthæœåŠ¡ç±»çŠ¶æ€:');
                if (window.alipayOAuth) {
                    statusInfo.push('âœ… æœåŠ¡ç±»å·²åŠ è½½');
                    statusInfo.push(`ğŸ“± AppID: ${window.alipayOAuth.config.appId}`);
                } else {
                    statusInfo.push('âŒ æœåŠ¡ç±»æœªåŠ è½½');
                }
                
                // æ£€æŸ¥å­˜å‚¨çŠ¶æ€
                statusInfo.push('\nğŸ’¾ å­˜å‚¨çŠ¶æ€:');
                const sessionState = sessionStorage.getItem('alipay_oauth_state');
                const localState = localStorage.getItem('alipay_oauth_state');
                
                if (sessionState) {
                    statusInfo.push(`âœ… SessionStorage: æœ‰çŠ¶æ€å‚æ•° (${sessionState.substring(0, 20)}...)`);
                } else {
                    statusInfo.push('â„¹ï¸ SessionStorage: æ— çŠ¶æ€å‚æ•°');
                }
                
                if (localState) {
                    statusInfo.push(`âœ… LocalStorage: æœ‰çŠ¶æ€å‚æ•° (${localState.substring(0, 20)}...)`);
                } else {
                    statusInfo.push('â„¹ï¸ LocalStorage: æ— çŠ¶æ€å‚æ•°');
                }
                
                // æ£€æŸ¥å›è°ƒå‚æ•°
                statusInfo.push('\nğŸ¯ å½“å‰é¡µé¢å›è°ƒå‚æ•°:');
                const urlParams = new URLSearchParams(window.location.search);
                const authCode = urlParams.get('auth_code');
                const state = urlParams.get('state');
                
                if (authCode && state) {
                    statusInfo.push('âœ… æ£€æµ‹åˆ°å›è°ƒå‚æ•°');
                    statusInfo.push(`ğŸ”‘ æˆæƒç : ${authCode.substring(0, 20)}...`);
                    statusInfo.push(`ğŸ”’ Stateå‚æ•°: ${state}`);
                } else {
                    statusInfo.push('â„¹ï¸ æ— å›è°ƒå‚æ•°');
                }
                
                resultEl.innerHTML = statusInfo.join('\n');
                
            } catch (error) {
                resultEl.innerHTML = `âŒ è·å–çŠ¶æ€å¤±è´¥: ${error.message}`;
                resultEl.className = 'result error';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ”¯ä»˜å®OAuth2å‰ç«¯åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            // è‡ªåŠ¨æ£€æŸ¥æœåŠ¡ç±»çŠ¶æ€
            setTimeout(() => {
                if (window.alipayOAuth) {
                    console.log('âœ… æ”¯ä»˜å®OAuthæœåŠ¡ç±»åŠ è½½æˆåŠŸ');
                } else {
                    console.error('âŒ æ”¯ä»˜å®OAuthæœåŠ¡ç±»åŠ è½½å¤±è´¥');
                }
            }, 100);
        });
    </script>
</body>
</html>